name: Build & Push Runtime Docker Images

on:
  push:
    branches: [ "main" ]
    paths:
      - "runtime/**"
      - "stages/**"
      - "proto/**"
      - ".github/workflows/runtime-images.yaml"
  release:
    types: [ published ]

permissions:
  contents: read
  packages: write

env:
  REGISTRY: ghcr.io
  IMAGE_NAMESPACE: hurdad
  OS_TAG: ubuntu24.04

jobs:
  # ------------------------------------------------------------
  # 1. Compute tag once (single source of truth)
  # ------------------------------------------------------------
  meta:
    runs-on: ubuntu-latest
    outputs:
      tag: ${{ steps.compute.outputs.tag }}
    steps:
      - uses: actions/checkout@v4

      - id: compute
        shell: bash
        run: |
          if [[ "${GITHUB_REF}" == refs/tags/v* ]]; then
            VERSION="${GITHUB_REF#refs/tags/v}"
            TAG="${VERSION}-${OS_TAG}"
          else
            BRANCH="${GITHUB_REF#refs/heads/}"
            TAG="${BRANCH}-${OS_TAG}"
          fi

          echo "tag=${TAG}" >> "$GITHUB_OUTPUT"
          echo "Computed tag: ${TAG}"

  # ------------------------------------------------------------
  # 2. Build & run runtime tests (gates image builds)
  # ------------------------------------------------------------
  tests:
    needs: meta
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential \
            cmake \
            ninja-build \
            pkg-config \
            git \
            libyaml-cpp-dev \
            libprotobuf-dev \
            protobuf-compiler \
            protobuf-compiler-grpc \
            libgrpc++-dev \
            libgtest-dev \
            libcurl4-openssl-dev \
            libspdlog-dev \
            libjemalloc-dev

      - name: Configure
        run: |
          cmake -S . -B build -G Ninja \
            -DCMAKE_BUILD_TYPE=Release \
            -DBUILD_TESTING=ON \
            -DFLOWPIPE_ENABLE_OTEL=OFF

      - name: Build
        run: cmake --build build

      - name: Run runtime tests
        run: ctest --test-dir build/runtime/tests --output-on-failure

  # ------------------------------------------------------------
  # 3. Build & push runtime image (root of tree) per-arch
  # ------------------------------------------------------------
  runtime-amd64:
    needs: [meta, tests]
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - uses: docker/setup-buildx-action@v3

      - uses: docker/build-push-action@v5
        with:
          context: .
          file: runtime/docker/Dockerfile
          target: runtime
          push: true
          platforms: linux/amd64
          tags: |
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAMESPACE }}/flow-pipe-runtime:${{ needs.meta.outputs.tag }}-amd64

  runtime-arm64:
    needs: [meta, tests]
    runs-on: [self-hosted, linux, arm64]

    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - uses: docker/setup-buildx-action@v3

      - uses: docker/build-push-action@v5
        with:
          context: .
          file: runtime/docker/Dockerfile
          target: runtime
          push: true
          platforms: linux/arm64
          tags: |
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAMESPACE }}/flow-pipe-runtime:${{ needs.meta.outputs.tag }}-arm64

  runtime-manifest:
    needs: [meta, runtime-amd64, runtime-arm64]
    runs-on: ubuntu-latest

    steps:
      - uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - uses: docker/setup-buildx-action@v3

      - name: Create multi-arch manifest
        run: |
          docker buildx imagetools create \
            -t ${{ env.REGISTRY }}/${{ env.IMAGE_NAMESPACE }}/flow-pipe-runtime:${{ needs.meta.outputs.tag }} \
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAMESPACE }}/flow-pipe-runtime:${{ needs.meta.outputs.tag }}-amd64 \
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAMESPACE }}/flow-pipe-runtime:${{ needs.meta.outputs.tag }}-arm64

  # ------------------------------------------------------------
  # 4. Build & push base image (depends on runtime) per-arch
  # ------------------------------------------------------------
  base-amd64:
    needs: [meta, runtime-manifest]
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - uses: docker/setup-buildx-action@v3

      - uses: docker/build-push-action@v5
        with:
          context: .
          file: runtime/docker/Dockerfile
          target: base
          push: true
          platforms: linux/amd64
          tags: |
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAMESPACE }}/flow-pipe-base:${{ needs.meta.outputs.tag }}-amd64

  base-arm64:
    needs: [meta, runtime-manifest]
    runs-on: [self-hosted, linux, arm64]

    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - uses: docker/setup-buildx-action@v3

      - uses: docker/build-push-action@v5
        with:
          context: .
          file: runtime/docker/Dockerfile
          target: base
          push: true
          platforms: linux/arm64
          tags: |
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAMESPACE }}/flow-pipe-base:${{ needs.meta.outputs.tag }}-arm64

  base-manifest:
    needs: [meta, base-amd64, base-arm64]
    runs-on: ubuntu-latest

    steps:
      - uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - uses: docker/setup-buildx-action@v3

      - name: Create multi-arch manifest
        run: |
          docker buildx imagetools create \
            -t ${{ env.REGISTRY }}/${{ env.IMAGE_NAMESPACE }}/flow-pipe-base:${{ needs.meta.outputs.tag }} \
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAMESPACE }}/flow-pipe-base:${{ needs.meta.outputs.tag }}-amd64 \
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAMESPACE }}/flow-pipe-base:${{ needs.meta.outputs.tag }}-arm64

  # ------------------------------------------------------------
  # 5. Build & push dev (SDK) image (depends on base) per-arch
  # ------------------------------------------------------------
  dev-amd64:
    needs: [meta, base-manifest]
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - uses: docker/setup-buildx-action@v3

      - uses: docker/build-push-action@v5
        with:
          context: .
          file: runtime/docker/Dockerfile
          target: dev
          push: true
          platforms: linux/amd64
          tags: |
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAMESPACE }}/flow-pipe-dev:${{ needs.meta.outputs.tag }}-amd64

  dev-arm64:
    needs: [meta, base-manifest]
    runs-on: [self-hosted, linux, arm64]

    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - uses: docker/setup-buildx-action@v3

      - uses: docker/build-push-action@v5
        with:
          context: .
          file: runtime/docker/Dockerfile
          target: dev
          push: true
          platforms: linux/arm64
          tags: |
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAMESPACE }}/flow-pipe-dev:${{ needs.meta.outputs.tag }}-arm64

  dev-manifest:
    needs: [meta, dev-amd64, dev-arm64]
    runs-on: ubuntu-latest

    steps:
      - uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - uses: docker/setup-buildx-action@v3

      - name: Create multi-arch manifest
        run: |
          docker buildx imagetools create \
            -t ${{ env.REGISTRY }}/${{ env.IMAGE_NAMESPACE }}/flow-pipe-dev:${{ needs.meta.outputs.tag }} \
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAMESPACE }}/flow-pipe-dev:${{ needs.meta.outputs.tag }}-amd64 \
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAMESPACE }}/flow-pipe-dev:${{ needs.meta.outputs.tag }}-arm64
