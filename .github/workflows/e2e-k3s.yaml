name: End-to-end k3s Helm install

on:
  workflow_dispatch:
  pull_request:
    paths:
      - ".github/workflows/e2e-k3s.yaml"
      - "deploy/helm/flow-pipe/**"
      - "flows/**"
      - "runtime/**"
      - "controller/**"
      - "api/**"

env:
  IMAGE_NAMESPACE: ghcr.io/${{ github.repository_owner }}
  IMAGE_TAG: e2e-${{ github.run_id }}-ubuntu24.04
  CLUSTER_NAME: flow-pipe-e2e
  NAMESPACE: flow-pipe
  USE_COMPOSE_K3S: ""

jobs:
  e2e:
    runs-on: ubuntu-latest
    timeout-minutes: 60
    continue-on-error: true
    permissions:
      contents: read

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Set up Helm
        uses: azure/setup-helm@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Install k3d
        if: env.USE_COMPOSE_K3S != 'true'
        run: |
          curl -s https://raw.githubusercontent.com/k3d-io/k3d/main/install.sh | bash

      - name: Run e2e script
        run: ./tools/e2e-k3s.sh
