name: Package Helm chart

on:
  push:
    branches: [ "main" ]
    paths:
      - "deploy/helm/**"
      - ".github/workflows/helm-package.yaml"
  release:
    types: [ published ]

permissions:
  contents: read

jobs:
  package:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Helm
        uses: azure/setup-helm@v4
        with:
          version: v3.14.4

      - name: Add Helm repositories
        run: |
          helm repo add prometheus-community https://prometheus-community.github.io/helm-charts
          helm repo add grafana https://grafana.github.io/helm-charts

      - name: Lint chart
        run: helm lint deploy/helm/flow-pipe

      - name: Build dependencies
        run: helm dependency update deploy/helm/flow-pipe

      - name: Package chart
        run: helm package deploy/helm/flow-pipe --destination packaged-charts

      - name: Upload packaged chart
        uses: actions/upload-artifact@v4
        with:
          name: flow-pipe-chart
          path: packaged-charts/*.tgz
          if-no-files-found: error
