# ============================================================
# Stage 1: Build + install flow-pipe runtime & stages
# ============================================================
FROM ubuntu:24.04 AS builder

ENV DEBIAN_FRONTEND=noninteractive

# ------------------------------------------------------------
# Build dependencies
# ------------------------------------------------------------
RUN apt-get update && apt-get install -y \
    build-essential \
    cmake \
    ninja-build \
    pkg-config \
    git \
    libyaml-cpp-dev \
    libprotobuf-dev \
    protobuf-compiler \
    protobuf-compiler-grpc \
    libgrpc++-dev \
    libcurl4-openssl-dev \
    libspdlog-dev \
    libjemalloc-dev \
    ca-certificates \
    && rm -rf /var/lib/apt/lists/*

# ------------------------------------------------------------
# Build workspace
# ------------------------------------------------------------
WORKDIR /build

# Copy source tree
COPY . .

# ------------------------------------------------------------
# Configure
# ------------------------------------------------------------
RUN cmake -S . -B build -G Ninja \
      -DCMAKE_BUILD_TYPE=Release \
      -DFLOWPIPE_ENABLE_OTEL=ON \
      -DCMAKE_INSTALL_PREFIX=/opt/flow-pipe

# ------------------------------------------------------------
# Build everything (runtime + in-tree stages)
# ------------------------------------------------------------
RUN cmake --build build

# ------------------------------------------------------------
# Install runtime, shared libs, headers, plugins
# ------------------------------------------------------------
RUN cmake --install build

# ============================================================
# Stage 2: Minimal runtime image
# ============================================================
FROM ubuntu:24.04

ENV DEBIAN_FRONTEND=noninteractive

# ------------------------------------------------------------
# Runtime-only shared library deps
# ------------------------------------------------------------
RUN apt-get update && apt-get install -y \
    libyaml-cpp0.8 \
    libgrpc++1.51t64 \
    libprotobuf32 \
    libspdlog1.12 \
    libcurl4t64 \
    libjemalloc2 \
    ca-certificates \
    && rm -rf /var/lib/apt/lists/*

# ------------------------------------------------------------
# Copy installed runtime from builder
# ------------------------------------------------------------
COPY --from=builder /opt/flow-pipe /opt/flow-pipe

# ------------------------------------------------------------
# Environment
# ------------------------------------------------------------
ENV FLOW_PIPE_ROOT=/opt/flow-pipe
ENV FLOW_PIPE_PLUGIN_PATH=/opt/flow-pipe/plugins
ENV LD_LIBRARY_PATH=/opt/flow-pipe/lib
ENV PATH=/opt/flow-pipe/bin:${PATH}

# ------------------------------------------------------------
# Sanity checks (fail fast)
# ------------------------------------------------------------
RUN test -f /opt/flow-pipe/bin/flow_runtime
RUN test -f /opt/flow-pipe/lib/libflowpipe_runtime.so
RUN ls /opt/flow-pipe/plugins/libstage_*.so

# ------------------------------------------------------------
# Entrypoint
# ------------------------------------------------------------
ENTRYPOINT ["/opt/flow-pipe/bin/flow_runtime"]
