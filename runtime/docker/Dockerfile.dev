# =====================================================
# flow-pipe SDK / Dev Image
# =====================================================

FROM ubuntu:24.04

ENV DEBIAN_FRONTEND=noninteractive

# -----------------------------------------------------
# System dependencies
# -----------------------------------------------------
RUN apt-get update && apt-get install -y \
    build-essential \
    cmake \
    ninja-build \
    pkg-config \
    git \
    libyaml-cpp-dev \
    libprotobuf-dev \
    protobuf-compiler \
    protobuf-compiler-grpc \
    libgrpc++-dev \
    libgtest-dev \
    libcurl4-openssl-dev \
    libspdlog-dev \
    libjemalloc-dev \
    ca-certificates \
    && rm -rf /var/lib/apt/lists/*

# -----------------------------------------------------
# Workdir
# -----------------------------------------------------
WORKDIR /src

# -----------------------------------------------------
# Copy source (expects submodules already present)
# -----------------------------------------------------
COPY . .

# -----------------------------------------------------
# Configure
# -----------------------------------------------------
RUN cmake -S . -B build -G Ninja \
      -DCMAKE_BUILD_TYPE=Debug \
      -DFLOWPIPE_ENABLE_OTEL=ON \
      -DCMAKE_INSTALL_PREFIX=/opt/flow-pipe

# -----------------------------------------------------
# Build (runtime + all stages)
# -----------------------------------------------------
RUN cmake --build build

# -----------------------------------------------------
# Install SDK (runtime, libs, headers, plugins)
# -----------------------------------------------------
RUN cmake --install build

# -----------------------------------------------------
# Sanity checks (fail fast)
# -----------------------------------------------------
# Runtime
RUN test -f /opt/flow-pipe/bin/flow_runtime
RUN test -f /opt/flow-pipe/lib/libflowpipe_runtime.so

# Headers
RUN test -f /opt/flow-pipe/include/flowpipe/stage.h
RUN test -f /opt/flow-pipe/include/flowpipe/plugin.h

# Plugins (examples)
RUN ls /opt/flow-pipe/plugins/libstage_*.so

# -----------------------------------------------------
# Environment (dev + downstream stage builds)
# -----------------------------------------------------
ENV FLOW_PIPE_ROOT=/opt/flow-pipe
ENV CMAKE_PREFIX_PATH=/opt/flow-pipe
ENV LD_LIBRARY_PATH=/opt/flow-pipe/lib
ENV PATH=/opt/flow-pipe/bin:${PATH}
