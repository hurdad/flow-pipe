syntax = "proto3";

package flowpipe.v1;

option go_package = "github.com/hurdad/flow-pipe/gen/go/flowpipe/v1;flowpipev1";

import "google/protobuf/struct.proto";
import "google/protobuf/timestamp.proto";
import "flowpipe/v1/observability.proto";

// ============================================================
// Flow (desired + observed state)
// ============================================================

message Flow {
  // Unique flow identifier.
  string name = 1;

  // Current spec version.
  uint64 version = 2;

  // Desired configuration.
  FlowSpec spec = 3;

  // Observed runtime state.
  FlowStatus status = 4;
}

// ============================================================
// Flow specification (desired state)
// ============================================================

message FlowSpec {
  // Logical flow name.
  string name = 1;

  // Immutable version assigned by the controller.
  uint64 version = 2;

  // Runtime environment selection.
  FlowRuntime runtime = 3;

  // Container image when using container runtime.
  optional string image = 4;

  // Execution semantics for the flow.
  optional Execution execution = 5;

  // Ordered pipeline stages.
  repeated StageSpec stages = 6;

  // Queues connecting stages.
  repeated QueueSpec queues = 7;

  // Optional CPU affinity per stage.
  map<string, CpuSet> cpu_pinning = 8;

  // Aggregate resource intent.
  optional Resources resources = 9;

  // User-defined metadata labels.
  map<string, string> labels = 10;

  // Flow-level observability overrides.
  optional ObservabilityConfig observability = 11;

  // Kubernetes runtime settings.
  optional KubernetesSettings kubernetes = 12;
}

// ============================================================
// Runtime environment
// ============================================================

enum FlowRuntime {
  // Runtime not specified.
  FLOW_RUNTIME_UNSPECIFIED = 0;

  // Built-in stages linked into runtime binary.
  FLOW_RUNTIME_BUILTIN = 1;

  // Stages executed inside a container image.
  FLOW_RUNTIME_CONTAINER = 2;
}

// Kubernetes runtime settings for flow workloads.
message KubernetesSettings {
  // Image pull policy for runtime pods.
  ImagePullPolicy image_pull_policy = 1;

  // Restart policy for runtime pods.
  RestartPolicy restart_policy = 2;
}

// Kubernetes image pull policy.
enum ImagePullPolicy {
  // Pull policy not specified (controller default).
  IMAGE_PULL_POLICY_UNSPECIFIED = 0;

  // Always pull the image.
  IMAGE_PULL_POLICY_ALWAYS = 1;

  // Pull if not present on node.
  IMAGE_PULL_POLICY_IF_NOT_PRESENT = 2;

  // Never pull the image.
  IMAGE_PULL_POLICY_NEVER = 3;
}

// Kubernetes restart policy for runtime pods.
enum RestartPolicy {
  // Restart policy not specified (controller default).
  RESTART_POLICY_UNSPECIFIED = 0;

  // Always restart the pod.
  RESTART_POLICY_ALWAYS = 1;

  // Restart on failure.
  RESTART_POLICY_ON_FAILURE = 2;

  // Never restart the pod.
  RESTART_POLICY_NEVER = 3;
}

// ============================================================
// Execution model
// ============================================================

message Execution {
  // Selected execution mode.
  ExecutionMode mode = 1;
}

enum ExecutionMode {
  // Execution mode not specified.
  EXECUTION_MODE_UNSPECIFIED = 0;

  // Long-running streaming pipeline.
  EXECUTION_MODE_STREAMING = 1;

  // Run-to-completion batch job.
  EXECUTION_MODE_JOB = 2;
}

// ============================================================
// Stage definition
// ============================================================

message StageSpec {
  // Unique stage name within the flow.
  string name = 1;

  // Stage type identifier.
  string type = 2;

  // Number of worker threads.
  uint32 threads = 3;

  // Input queue name (if any).
  optional string input_queue = 4;

  // Output queue name (if any).
  optional string output_queue = 5;

  // Opaque, plugin-owned config
  google.protobuf.Struct config = 6;

  // Optional plugin implementation override.
  optional string plugin = 7;
}

// ============================================================
// Queue definition
// ============================================================

message QueueSpec {
  // Queue name.
  string name = 1;

  // Maximum buffered elements.
  uint32 capacity = 2;
}

// ============================================================
// Resource intent
// ============================================================

message Resources {
  // Preferred total CPU cores.
  optional uint32 cpu_cores = 1;

  // Preferred memory allocation in MB.
  optional uint32 memory_mb = 2;

  // Named resource profile hint.
  optional string profile = 3;
}

// ============================================================
// CPU pinning hint
// ============================================================

message CpuSet {
  // CPU core identifiers.
  repeated uint32 cpu = 1;
}

// ============================================================
// Flow status (observed state)
// ============================================================

message FlowStatus {
  // Current lifecycle state.
  FlowState state = 1;

  // Human-readable status message.
  string message = 2;

  // Currently active version.
  uint64 active_version = 3;

  // Kubernetes workload name.
  string workload = 4;

  // Last controller reconciliation time.
  google.protobuf.Timestamp last_updated = 5;
}

enum FlowState {
  // State not specified.
  FLOW_STATE_UNSPECIFIED = 0;

  // Awaiting scheduling or resources.
  FLOW_STATE_PENDING = 1;

  // Being deployed or updated.
  FLOW_STATE_DEPLOYING = 2;

  // Actively running.
  FLOW_STATE_RUNNING = 3;

  // Completed successfully (jobs only).
  FLOW_STATE_SUCCEEDED = 4;

  // Execution failed.
  FLOW_STATE_FAILED = 5;

  // Explicitly stopped.
  FLOW_STATE_STOPPED = 6;
}

// ============================================================
// Generic typed value
// ============================================================

message Value {
  // Concrete value type.
  oneof kind {
    // String scalar.
    string string_value = 1;

    // Signed integer scalar.
    int64 int_value = 2;

    // Unsigned integer scalar.
    uint64 uint_value = 3;

    // Floating-point scalar.
    double double_value = 4;

    // Boolean scalar.
    bool bool_value = 5;

    // List of strings.
    StringList string_list = 6;

    // List of signed integers.
    IntList int_list = 7;

    // List of unsigned integers.
    UIntList uint_list = 8;

    // List of doubles.
    DoubleList double_list = 9;

    // List of booleans.
    BoolList bool_list = 10;

    // Nested structured value.
    Struct struct_value = 11;
  }
}

message Struct {
  // Named structured fields.
  map<string, Value> fields = 1;
}

// List of strings.
message StringList {repeated string values = 1;}

// List of signed integers.
message IntList {repeated int64 values = 1;}

// List of unsigned integers.
message UIntList {repeated uint64 values = 1;}

// List of doubles.
message DoubleList {repeated double values = 1;}

// List of booleans.
message BoolList {repeated bool values = 1;}
